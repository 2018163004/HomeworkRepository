<!DOCTYPE html>
<html>
    <head>
        <meta charset = "utf-8">
        <title>index</title>

        <link rel="stylesheet" type= "text/css" href= "main.css">
        <script>
            fetch('product.json').then(function(response) {
                return response.json();
            }).then(function(json) {
                let products = json;
                initialize(products);
            }).catch(function(err) {
                console.log('error:' + err.message);
            });
            
            window.onscroll = () => {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight){
                    initialize(products);
                }
            }

            function initialize(products){
                const category = document.querySelector('#category');
                const search = document.querySelector('#search');
                const searchbutton = document.querySelector('button');
                const main = document.querySelector('main');
                let categoryGroup;
                let finalGroup;
                finalGroup = products;
                updateDisplay();
                
                searchbutton.onclick = selectCategory;
                
                function selectCategory(evt) {
                    evt.preventDefault();
                    categoryGroup = [];
                    finalGroup = [];
                    if (category.value === 'All'){
                        categoryGroup = products;
                        selectProduct();
                    } else {
                        for(let i =0; i < products.length ; i++) {
                            if (product[i].type == category.value){
                                categoryGroup.push(products[i]);
                            }
                        }
                        selectProduct();
                    }
                }
                function selectProduct(){
                    if(search.value.trim() === '') {
                        finalGroup = categoryGroup;
                        updateDisplay();
                    } else {
                        for (let i=0; i < categoryGroup.length; i++) {
                            if(categoryGroup[i].name.indexOf(search.value.trim()) !== -1){
                                finalGroup.push(categoryGroup[i]);
                            }
                        }
                    }
                    updateDisplay();
                }
                function updateDisplay(){
                    while (main.firstChild){
                        main.removeChild(main.firstChild);
                    }
                    if(finalGroup.length === 0){
                        const para = document.createElement('p');
                        para.textContent = 'No result!';
                        main.appendChild(para);
                    } else {
                        for (let i=0; i<finalGroup.length; i++){
                            fetchBlob(finalGroup[i]);
                        }
                    }
                }
                function fetchBlob(product){
                    let url = 'images/'+ product.image;
                    fetch(url).then(function(response){
                        return response.blob();
                    }).then(function(blob) {
                        let objectURL = URL.createObjectURL(blob);
                        showProduct(objectURL,product);
                    });
                }
                function showProduct(objectURL,product){
                    const section = document.createElement('section');
                    const heading = document.createElement('p');
                    const para = document.createElement('p');
                    const image = document.createElement('img');
                    const btn = document.createElement('button');
                    btn.textContent='Click';
                    
                    section.setAttribute('class', product.type);
                    heading.textContent = product.name;
                    para.textContent = product.price;
                    image.src =objectURL;
                    image.alt = product.name;
                    main.appendChild(section);
                    function showMore(){
                        section.appendChild(heading);
                        section.appendChild(para);
                    }
                    section.appendChild(image);
                    section.appendChild(btn);
                    btn.onclick = showMore;
                }
            }
        </script>
      
    </head>
    <body>
        <div class = "header">
            <p id="hello">안녕하세요 인프밍 카페입니다.</p>
        </div>
        <div>
            <p>
                <a href = "https://2018163004.github.io/HomeworkRepository/LAB4/index.html">메인페이지</a>
                <a href = "https://2018163004.github.io/HomeworkRepository/LAB4/login.html">로그인</a>
                <a href = "https://2018163004.github.io/HomeworkRepository/LAB4/signup.html">회원가입</a>
            </p>
        </div>
        <div>
            <aside>
                <form>
                    <div>
                        <label for='category'>Choose a category:</label>
                        <select id='category'>
                            <option selected>All</option>
                            <option>champion</option>
                            <option>skin</option>
                            <option>set</option>
                        </select>
                    </div>
                    <div>
                        <label for='search'>Enter search term</label>
                        <input type='text' id='search' placeholder = 'e.g. 루시안'>
                    </div>
                    <div>
                        <button>Filter results</button>
                    </div>
                </form>
            </aside>
            <main>
            </main>
        </div>
    </body>
</html>