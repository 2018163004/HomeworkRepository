<!DOCTYPE html>
<html>
    <head>
        <meta charset = "utf-8">
        <title>index</title>

        <link rel="stylesheet" type= "text/css" href= "main.css">
        <script>
            fetch('product.json').then(function(response) {
                return response.json();
            }).then(function(json) {
                let products = json;
                initialize(products);
            }).catch(function(err) {
                console.log('error:' + err.message);
            });
            
            window.onscroll = () => {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight){
                    initialize(products);
                }
            }

            function initialize(products){
                const category = document.querySelector('#category');
                const search = document.querySelector('#search');
                const searchbutton = document.querySelector('button');
                const main = document.querySelector('main');
                let categoryG;
                let finalG;
                finalG = products;
                Display();
                
                searchbutton.onclick = selectCategory;
                
                function selectCategory(evt) {
                    evt.preventDefault();
                    categoryG = [];
                    finalG = [];
                    if (category.value === 'All'){
                        categoryG = products;
                        searchP();
                    } else {
                        for(let i =0; i < products.length ; i++) {
                            if (products[i].type === category.value){
                                categoryG.push(products[i]);
                            }
                        }
                        searchP();
                    }
                }
                function searchP(){
                    if(search.value.trim() === '') {
                        finalG = categoryG;
                        Display();
                    } else {
                        for (let i=0; i < categoryG.length; i++) {
                            if(categoryG[i].name.indexOf(search.value.trim()) !== -1){
                                finalG.push(categoryG[i]);
                            }
                        }
                        Display();
                    }
                }
                function Display(){
                    while (main.firstChild){
                        main.removeChild(main.firstChild);
                    }
                    if(finalG.length === 0){
                        const noresult = document.createElement('p');
                        noresult.textContent = 'No result!';
                        main.appendChild(noresult);
                    } else {
                        for (let i=0; i<finalG.length; i++){
                            appendB(finalG[i]);
                        }
                    }
                }
                function appendB(product){
                    let url = 'images/'+ product.image;
                    fetch(url).then(function(response){
                        return response.blob();
                    }).then(function(blob) {
                        let objectURL = URL.createObjectURL(blob);
                        DisplayP(objectURL,product);
                    });
                }
                function DisplayP(objectURL,product){
                    const section = document.createElement('section');
                    const Pname = document.createElement('p');
                    const Pprice = document.createElement('p');
                    const image = document.createElement('img');
                    const btn = document.createElement('button');
                    btn.textContent='Click';
                    
                    section.setAttribute('class', product.type);
                    Pname.textContent = product.name;
                    Pprice.textContent = product.price;
                    image.src =objectURL;
                    image.alt = product.name;
                    main.appendChild(section);
                    function btndisplay(){
                        section.appendChild(Pname);
                        section.appendChild(Pprice);
                    }
                    section.appendChild(image);
                    section.appendChild(btn);
                    btn.onclick = btndisplay;
                }
            }
        </script>
      
    </head>
    <body>
        <div class = "header">
            <p id="hello">안녕하세요 인프밍 카페입니다.</p>
        </div>
        <div>
            <p>
                <a href = "https://2018163004.github.io/HomeworkRepository/LAB4/index.html">메인페이지</a>
                <a href = "https://2018163004.github.io/HomeworkRepository/LAB4/login.html">로그인</a>
                <a href = "https://2018163004.github.io/HomeworkRepository/LAB4/signup.html">회원가입</a>
            </p>
        </div>
        <div>
            <form>
                <div>
                    <label for='category'>Choose a category:</label>
                    <select id='category'>
                        <option selected>All</option>
                        <option>champion</option>
                        <option>skin</option>
                        <option>set</option>
                    </select>
                </div>
                <div>
                    <label for='search'>Enter search term</label>
                    <input type='text' id='search' placeholder = 'e.g. 루시안'>
                </div>
                <div>
                    <button>Filter results</button>
                </div>
            </form>
            <main>
            </main>
        </div>
    </body>
</html>