<!DOCTYPE html>
<html>
    <head>
        <meta charset = "utf-8">
        <title>index</title>

        <link rel="stylesheet" type= "text/css" href= "main.css">
        <script>
            let products;
            fetch('product.json').then(function(response) {
                return response.json();
            }).then(function(json) {
                products = json;
                initialize(products);
            }).catch(function(err) {
                console.log('error:' + err.message);
            });
            
            window.onscroll = () => {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight){
                    initialize(products);
                }
            };
            function initialize(product){
                const category = document.querySelector('#category');
                const search = document.querySelector('#search');
                const searchbutton = document.querySelector('button');
                const main = document.querySelector('main');
                
                let finalGroup = product;
                updateDisplay();
                
                searchbutton.onclick = selectCategory();
                function selectCategory() {
                    let categoryGroup = [];
                    let finalGroup = [];
                    if (category.value === 'All'){
                        categoryGroup = product;
                        selectProduct();
                    }
                    else {
                        let CaseType = category.value;
                        for(let i =0; i < product.length ; i++){
                            if (product[i].type === CaseType){
                                categoryGroup.push(product[i]);
                            }
                        }
                        selectProduct();
                    }
                }
                function selectProduct(){
                    for (let i=0; i<product.length; i++){
                        if(categoryGroup[i].name.indexOf(search) !== -1){
                            finalGroup.push(categoryGroup[i]);
                        }
                    }
                    updateDisplay();
                }
                function updateDisplay(){
                    while (main.firstChild){
                        main.removeChild(main.firstChild);
                    }
                    if(finalGroup.length === 0){
                        const para = document.createElement('p');
                        para.textContent = 'No result to display!';
                        main.appendChild(para);
                    }
                    else {
                        for (let i=0; i<finalGroup.length; i++){
                            fetchBlob(finalGroup[i]);
                        }
                    }
                }
                function fetchBlob(product){
                    let url = 'images/'+ product.image;
                    fetch(url).then(function(response){
                        return response.blob();
                    }).then(function(blob) {
                        let objectURL = URL.createObjectURL(blob);
                        showProduct(objectURL,product);
                    });
                }
                function showProduct(objectURL,product){
                    const section = document.createElement('section');
                    const heading = document.createElement('p');
                    const para = document.createElement('p');
                    const image = document.createElement('img');
                    const btn = document.createElement('button');
                    btn.textContent='Click to see more';
                    
                    section.setAttribute('class', product.type);
                    heading.textContent = product.name;
                    para.textContent = product.price;
                    image.src =objectURL;
                    image.alt = product.name;


                    main.appendChild(section);
                    function showMore(){
                        section.appendChild(heading);
                        section.appendChild(para);
                    }
                    section.appendChild(image);
                    section.appendChild(btn);
                    btn.onclick = showMore();
                }
            }
        </script>
      
    </head>
    <body>
        <div class = "header">
            <p id="hello">안녕하세요 인프밍 카페입니다.</p>
        </div>
        <div>
            <p>
                <a href = "https://2018163004.github.io/HomeworkRepository/LAB4/index.html">메인페이지</a>
                <a href = "https://2018163004.github.io/HomeworkRepository/LAB4/login.html">로그인</a>
                <a href = "https://2018163004.github.io/HomeworkRepository/LAB4/signup.html">회원가입</a>
            </p>
        </div>
        <div>
            <aside>
                <form>
                    <div>
                        <label for='category'>Choose a category:</label>
                        <select id='category'>
                            <option selected>All</option>
                            <option>champion</option>
                            <option>skin</option>
                            <option>set</option>
                        </select>
                    </div>
                    <div>
                        <label for='search'>Enter search term</label>
                        <input type='text' id='search' placeholder = 'e.g. champion'>
                    </div>
                    <div>
                        <button>Filter results</button>
                    </div>
                </form>
            </aside>
            <main>
            </main>
        </div>
    </body>
</html>